{% extends "frontend/pagina_principal.html" %}
{% load static %}
{% load cloudinary_filters %}
{% block content %}
  
<div class="container py-4" style="padding-top: 80px;">

    <div class="d-flex justify-content-between align-items-center mb-4">
        
        {% if request.user.is_superuser %}
            {% if messages %}
                <div class="position-absolute start-50 translate-middle-x" style="z-index: 1050; top: 100px; width: 80%; max-width: 600px;">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} shadow-sm">
                            {{ message }}
                        </div> 
                    {% endfor %}
                </div>
            {% endif %}
        {% endif %}

        <h3 class="fw-bold text-dark mb-0">
            <i class="bi bi-clipboard-check text-success"></i> Planes de AlimentaciÃ³n
        </h3>

        <a href="{% url 'frontend:recetas' %}" class="btn rounded-pill text-white px-4 py-2"
           style="background: linear-gradient(45deg, #8d63d1, #5cb85c); box-shadow: 0 3px 8px rgba(0,0,0,0.15);">
            <i class="bi bi-book-fill"></i> Ver Recetas
        </a>
    </div>

    <div class="d-flex align-items-center flex-wrap gap-2 mb-4" id="objetivo-filtros">
        <span class="text-muted fw-bold small text-uppercase me-2">Filtrar por:</span>
        <button class="btn btn-sm btn-dark rounded-pill px-3 active" data-filter="todos">Todos</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" data-filter="recomposicion">RecomposiciÃ³n</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" data-filter="deficit">Descenso de Peso</button>
        <button class="btn btn-sm btn-outline-secondary rounded-pill px-3" data-filter="hipertrofia">Aumento Muscular</button>
    </div>

    {% if request.user.is_superuser %}
        <div class="mb-4 text-end">
            <a href="{% url 'frontend:gestion_planes' %}" class="btn text-white rounded-pill px-4" style="background-color: #5cb85c;">
                <i class="bi bi-gear"></i> Administrar Planes
            </a>
        </div>
    {% endif %}

    {% if planes %}
        <div class="row g-4">
            {% for plan in planes %}
                <div class="col-12 col-md-6 col-lg-4 plan-card" data-objetivo="{{ plan.objetivo }}">
                    
                    <div class="card h-100 shadow-sm rounded-4 overflow-hidden transition-hover" 
                         style="cursor: pointer;"
                         data-bs-toggle="modal" 
                         data-bs-target="#planModal{{ plan.id }}">
                        
                        {% if plan.portada %}
                            <img src="{{ plan.portada.url|optimize_url:400 }}" class="card-img-top" style="height: 220px; object-fit: contain; transition: transform 0.3s;" alt="{{ plan.titulo }}">
                        {% endif %}
                        
                        <div class="card-body">
                            <h5 class="fw-bold mb-3">{{ plan.titulo }}</h5>
                            <p class="text-muted small">{{ plan.descripcion }}</p>
                        </div>
                    </div>

                    <div class="modal fade" id="planModal{{ plan.id }}" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content rounded-4 border-0 shadow">
                                <div class="modal-header">
                                    <h4 class="modal-title fw-bold">{{ plan.titulo }}</h4>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    {% if plan.portada %}
                                        <img src="{{ plan.portada.url|optimize_url:800 }}" class="img-fluid mb-3 rounded" alt="{{ plan.titulo }}">
                                    {% endif %}
                                    
                                    <h5 class="mt-3 fw-semibold">Archivos disponibles:</h5>
                                    
                                    <ul class="list-group mb-3">
                                        {% for archivo in plan.archivos.all %}
                                            <li class="list-group-item flex-column align-items-start border-0 border-bottom pt-3 pb-3">
                                                <div class="d-flex justify-content-between align-items-center w-100">
                                                    <span class="fw-semibold">ðŸ“„ {{ archivo.nombre|default:"Archivo" }}</span>
                                                </div>
                                                
                                                <button type="button" class="btn btn-outline-primary mt-2 w-100 rounded-pill" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#modalArchivo{{ archivo.id }}">
                                                    <i class="bi bi-eye-fill me-2"></i> Ver Material
                                                </button>
                                            </li>
                                        {% empty %}
                                            <li class="list-group-item text-center text-muted">
                                                No hay archivos cargados para este plan.
                                            </li>
                                        {% endfor %}
                                    </ul>
                                    
                                    <p class="text-muted small mt-3 border-top pt-3">{{ plan.descripcion }}</p>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5">
            <div class="mb-3 text-muted display-1"><i class="bi bi-journal-x"></i></div>
            <h4>No hay planes disponibles aÃºn.</h4>
        </div>
    {% endif %}

</div>

{% for plan in planes %}
  {% for archivo in plan.archivos.all %}
    <div class="modal fade" id="modalArchivo{{ archivo.id }}" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-dark text-white">
                
                <div class="modal-header border-0">
                    <h5 class="modal-title">{{ archivo.nombre }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body p-0" style="height: 80vh;">
                    <embed 
                        src="{{ archivo.archivo.url }}#toolbar=0&navpanes=0&scrollbar=0" 
                        type="application/pdf"
                        width="100%" 
                        height="100%" 
                        style="border: none;"
                        oncontextmenu="return false;">
                </div>

                <div class="modal-footer border-0">
                    <button class="btn btn-secondary" data-bs-target="#planModal{{ plan.id }}" data-bs-toggle="modal">
                        <i class="bi bi-arrow-left"></i> Volver al Plan
                    </button>
                </div>

            </div>
        </div>
    </div>
  {% endfor %}
{% endfor %}

<style>
    .transition-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .transition-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1)!important; }
    
    .btn-dark.active { background-color: #7e2864; border-color: #7e2864; }
  
    .plan-card h5, .card-body h5 {
        display: block;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .modal-body h4, .modal-body p, .modal-body * {
        max-width: 100%;
        word-break: break-word;
        overflow-wrap: break-word;
    }
    .modal-title {
        max-width: 85%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. LÃ³gica de Filtros
    const buttons = document.querySelectorAll('[data-filter]');
    const cards = document.querySelectorAll('.plan-card');
    let currentFilter = 'todos';

    function updateFilters() {
        cards.forEach(card => {
            const objetivo = card.dataset.objetivo || '';
            const show = (currentFilter === 'todos' || currentFilter === objetivo);
            card.style.display = show ? 'block' : 'none'; 
        });
    }

    buttons.forEach(btn => {
        btn.addEventListener('click', () => {
            buttons.forEach(b => {
                b.classList.remove('active', 'btn-dark');
                b.classList.add('btn-outline-secondary', 'bg-white', 'text-dark');
            });
            btn.classList.add('active', 'btn-dark');
            btn.classList.remove('btn-outline-secondary', 'bg-white', 'text-dark');
            currentFilter = btn.dataset.filter;
            updateFilters();
        });
    });
});
</script>
{% endblock %}