{% extends "frontend/pagina_principal.html" %}
{% load static %}
{% load cloudinary_filters %}
{% block content %}

<section class="gestion-section py-5" style="padding-top: 80px;">
  <div class="container">

    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="fw-bold"><i class="bi bi-file-earmark-bar-graph text-primary"></i> Gesti√≥n de Planes Nutricionales</h2>
      <a href="{% url 'frontend:panel_admin' %}" class="btn btn-outline-secondary rounded-pill px-3">‚Üê Volver al Panel</a>
    </div>

    <div class="card shadow-sm border-0 rounded-4 p-4 mb-5">
        <h5 class="fw-bold mb-4 text-muted">
            {% if plan_edit %}Editar Plan (ID: {{ plan_edit.id }}){% else %}Agregar Nuevo Plan{% endif %}
        </h5>

        {% if messages %}
            <div class="mb-3">
                {% for message in messages %}
                <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %} text-center">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" action="">
            {% csrf_token %}

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">T√≠tulo *</label>
                    <input type="text" name="titulo" class="form-control" value="{{ plan_edit.titulo|default:'' }}" required maxlength="255">
                </div>
                
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Imagen de Portada (opcional)</label>
                    {% if plan_edit.portada %}
                        <div class="mb-2">
                            <img src="{{ plan_edit.portada.url|optimize_url:100 }}" class="rounded" style="width:100px; height:auto;">
                            <p class="small text-muted mt-1 mb-0">Actual: {{ plan_edit.portada.name }}</p>
                        </div>
                    {% endif %}
                    <input type="file" name="portada" class="form-control" accept="image/*">
                    
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label fw-semibold">Descripci√≥n (opcional)</label>
                <textarea name="descripcion" class="form-control" rows="2">{{ plan_edit.descripcion|default:'' }}</textarea>
            </div>

            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Objetivo *</label>
                    <select name="objetivo" class="form-select" required>
                        <option value="">Seleccionar...</option>
                        <option value="recomposicion" {% if plan_edit and plan_edit.objetivo == "recomposicion" %}selected{% endif %}>Recomposici√≥n corporal</option>
                        <option value="deficit" {% if plan_edit and plan_edit.objetivo == "deficit" %}selected{% endif %}>Descenso de masa adiposa</option>
                        <option value="hipertrofia" {% if plan_edit and plan_edit.objetivo == "hipertrofia" %}selected{% endif %}>Aumento de masa muscular</option>
                          
                      </select>
                </div>
                
                <div class="col-md-6 d-flex align-items-center mt-4">
                    <div class="form-check">
                    <input type="checkbox" name="destacado" class="form-check-input" id="destacado" {% if plan_edit and plan_edit.destacado %}checked{% endif %}>
                    <label for="destacado" class="form-check-label">Destacado</label>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="form-label fw-semibold">Archivos de Contenido (PDF/Imagen) *</label>
                {% if plan_edit and plan_edit.archivos.all %}
                  <div class="card p-3 mb-2" style="background-color: #f8f9fa; border: 1px dashed #ced4da;">
                      <p class="small text-muted fw-bold mb-2">Archivos ya cargados:</p>
                      <ul class="list-unstyled mb-0">
                          {% for archivo in plan_edit.archivos.all %}
                              <li class="d-flex align-items-center mb-1 text-muted">
                                  <i class="bi bi-check-circle-fill text-success me-2"></i>
                                  {{ archivo.nombre }}
                              </li>
                          {% endfor %}
                      </ul>
                  </div>
                  <p class="form-text mt-0 mb-3 text-primary">
                      <i class="bi bi-info-circle"></i> Los archivos de arriba ya est√°n guardados. Si us√°s el bot√≥n de abajo, <strong>agregar√°s</strong> archivos nuevos a esta lista.
                  </p>
              {% endif %}

              <label class="form-label small text-muted">Agregar nuevos archivos:</label>
              <input type="file" name="archivo" class="form-control" accept=".pdf,image/*" multiple 
                    {% if not plan_edit %}required{% endif %}>
                      </div>

            <div class="text-end">
                <button type="submit" class="btn btn-primary rounded-pill px-4 mt-2">
                    {% if plan_edit %}Guardar cambios{% else %}Crear Plan{% endif %}
                </button>
            </div>
        </form>
    </div>


    <div>
      <h5 class="fw-bold text-muted mb-3">Planes existentes</h5>
      
      {% if planes %}
          <div class="row"> {% for plan in planes %}
                  <div class="col-12 col-md-6 col-lg-4 mb-4">
                      <div class="card border-0 shadow-sm rounded-4 h-100">
                          
                          {% if plan.portada %}
                            <img src="{{ plan.portada.url|optimize_url:300 }}" class="card-img-top rounded-top" alt="{{ plan.titulo }}" style="height: 150px; object-fit: cover;">
                          {% else %}
                              <div class="p-4 text-center text-muted" style="background-color: #f0f8f0; height: 150px; display: flex; align-items: center; justify-content: center;">
                                  üìë Sin Portada
                              </div>
                          {% endif %}
                          
                          <div class="card-body d-flex flex-column">
                              <h6 class="fw-bold">{{ plan.titulo }}</h6>
                              <p class="small text-muted mb-2">
                                  <span class="badge bg-light text-dark border">{{ plan.get_objetivo_display|default:"General" }}</span>
                              </p>

                              <div class="mb-3 flex-grow-1">
                                  <p class="small text-muted mb-1 fw-bold">Archivos adjuntos:</p>
                                  {% for archivo in plan.archivos.all %}
                                      <div class="d-flex align-items-center small text-muted mb-1">
                                          <i class="bi bi-file-earmark-pdf me-1 text-danger"></i> 
                                          {{ archivo.nombre|truncatechars:20 }}
                                      </div>
                                  {% empty %}
                                      <span class="small text-muted fst-italic">Sin archivos</span>
                                  {% endfor %}
                              </div>
                              
                              <div class="d-flex justify-content-between mt-auto pt-3 border-top">
                                  <a href="?edit={{ plan.id }}" class="btn btn-sm btn-outline-primary px-3 rounded-pill">
                                      <i class="bi bi-pencil"></i> Editar
                                  </a>
                                  
                                  <form method="post" action="{% url 'frontend:gestion_planes_delete' plan_id=plan.id %}" onsubmit="return confirm('¬øSeguro que quer√©s eliminar el plan {{ plan.titulo }}?');" style="display:inline;">
                                      {% csrf_token %}
                                      <button type="submit" class="btn btn-sm btn-outline-danger px-3 rounded-pill">
                                          <i class="bi bi-trash"></i>
                                      </button>
                                  </form>
                              </div>
                          </div>
                      </div>
                  </div>
              {% endfor %}
          </div>
      {% else %}
          <div class="alert alert-light text-center border p-5">
              <p class="text-muted mb-0">No hay planes cargados a√∫n.</p>
          </div>
      {% endif %}
  </div>

  </div>
</section>
{% endblock %}