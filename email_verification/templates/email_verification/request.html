{% extends "email_verification/base.html" %}

{% block email_content %}
<style>
  /* === ESTILOS UNIFICADOS === */
  .pm-wrapper { 
    min-height: calc(100vh - 160px); 
    display:flex; 
    align-items:center; 
    justify-content:center; 
    padding:40px 0; 
  }
  .pm-card { 
    width:100%; 
    max-width:540px; 
    background:#fff8f0; 
    border:3px solid #c875ac; 
    border-radius:12px; 
    padding:22px; 
    color:#5a4630; 
    box-shadow:0 12px 30px rgba(2,6,23,0.06); 
    text-align:center;
  }
  .pm-card h1 { font-size:1.4rem; margin-bottom:8px; color:#7e2864; }
  .pm-card p { color:#5a4630; margin-bottom:12px; }
  .pm-btn { 
    width:100%; 
    display:block; 
    padding:12px 14px; 
    border-radius:10px; 
    background:linear-gradient(45deg,#c875ac,#7e2864); 
    color:#fff; 
    text-decoration:none; 
    text-align:center; 
    margin-top:10px; 
    font-weight:600; 
    border:none; 
    cursor:pointer; 
    transition:all .2s ease; 
  }
  .pm-btn:hover { transform:translateY(-1px); box-shadow:0 4px 10px rgba(0,0,0,0.1); }
  .pm-btn:disabled { background: #ccc; cursor: not-allowed; } /* Estilo deshabilitado */
  
  .pm-note { font-size:.9rem; color:#94a3b8; margin-top:8px; }
  .pm-back { margin-top:14px; text-align:center; }
  .ev-msg { color:#b53f3f; margin-bottom:10px; }
  .ev-resend {
    display:inline-block; margin-top:10px; background:transparent; border:2px solid #c875ac;
    color:#7e2864; font-weight:600; padding:8px 14px; border-radius:10px; text-decoration:none; transition:all .2s ease;
  }
  .ev-resend:hover { background:#c875ac; color:white; transform:translateY(-1px); box-shadow:0 3px 8px rgba(0,0,0,0.2); }
  
  @media (max-width:576px){ .pm-card{ padding:18px;} }
  /* ==== RESPONSIVE PARA CELULARES === */
@media (max-width: 480px) {

  /* Achica la tarjeta y deja márgenes */
  .pm-card {
    max-width: 90% !important;
    width: 90% !important;
    margin: 0 auto;
    padding: 18px !important;
    border-width: 2px;
  }

  .pm-card h1 {
    font-size: 1.2rem !important;
  }

  .pm-card p {
    font-size: 0.95rem !important;
    line-height: 1.4;
    word-break: break-word;   /* ← Esto evita que el email rompa el diseño */
  }

  /* Botones más chicos, centrados */
  .pm-btn {
    font-size: 1rem !important;
    padding: 10px !important;
    width: 100% !important;
  }

  .ev-resend {
    font-size: 0.95rem !important;
    padding: 8px 10px !important;
  }

  /* Inputs más pequeños */
  .pm-input, 
  .ev-input {
    font-size: 1rem !important;
    padding: 10px !important;
  }

  /* Reduce tamaño del icono check del plan activo */
  .bi-check-circle-fill {
    font-size: 2.4rem !important;
  }

  .alert {
    font-size: 0.95rem !important;
    padding: 10px !important;
  }
}

</style>

<div class="pm-wrapper" id="request-wrapper" data-wait="{{ resend_wait|default:0 }}">
  <div class="pm-card">

    {% if already_verified %}
      
      {% if plan_activo %}
          <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
          <h1 class="mt-2">¡Ya tenés acceso!</h1>
          
          <div class="alert alert-success rounded-4 text-center border-0" style="background-color: #d4edda; color: #155724;">
              Tu plan está activo hasta el <strong>{{ vencimiento|date:"d/m/Y" }}</strong>.
          </div>
          
          <p>No debes pagar de nuevo para entrenar.</p>

          <div class="d-grid gap-2 mt-4">
              <a href="{% url 'frontend:login' %}" class="pm-btn">
                  <i class="bi bi-box-arrow-in-right"></i> Ir a Iniciar Sesión
              </a>
              
              
          </div>

    {% else %}
        <h1>Correo verificado</h1>
        <p>El correo <strong>{{ email }}</strong> está verificado pero 
          {% if vencimiento %}tu plan venció el {{ vencimiento|date:"d/m/Y" }}{% else %}no tiene un plan activo{% endif %}.
        </p>
          
        <a href="{% url 'principal:metodos_pago' %}{% if request.session.monto %}?monto={{ request.session.monto|urlencode }}{% endif %}" class="pm-btn">
          Ir a pagar
        </a>
          
        <div class="pm-back mt-3">
          <a href="{% url 'principal:pagos' %}" class="ev-resend">Cambiar Plan</a>
        </div>
    {% endif %}

    {% else %}
      <h1>Verificá tu email</h1>
      <p>Ingresá tu correo para recibir el código de verificación.</p>

      {% if messages %}
        <div class="ev-msg">
          {% for m in messages %}
            <div>{{ m }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form id="request-form" method="post" action="" class="ev-form" novalidate style="display:flex; flex-direction:column; gap:12px; align-items:center;">
        {% csrf_token %}

        {% if form.email.errors %}
          <div style="color:#b53f3f; font-size:0.95rem; text-align:center;">
            {% for err in form.email.errors %}
              <div>{{ err }}</div>
            {% endfor %}
          </div>
        {% else %}
          <div style="min-height:22px;"></div>
        {% endif %}

        <div style="width:100%; max-width:420px;">
          {% if form.email %}
            {{ form.email }}
          {% else %}
            <input name="email" type="email" class="pm-input ev-input" placeholder="tu@mail.com" required>
          {% endif %}
        </div>

        <button id="btn-send" type="submit" class="pm-btn" {% if already_verified %}disabled{% endif %}>
          Enviar código
        </button>

        <div id="request-info" class="pm-note" style="margin-top:10px; font-weight:bold; color:#7e2864; min-height:20px;">
             </div>

      </form>

      <p class="pm-note">Te enviaremos un código que vence en unos minutos.</p>
      <p class="pm-note" style="color:#b53f3f; font-weight:bold;">El correo puede demorar algunos minutos en llegar.</p>
    {% endif %}
  </div>
</div>

<script>
(function(){
  // elementos
  const wrapper = document.getElementById('request-wrapper');
  const infoEl = document.getElementById('request-info');
  const btnSend = document.getElementById('btn-send');

  // leer wait seguro desde data-attribute
  let wait = 0;
  if (wrapper) {
    const raw = wrapper.getAttribute('data-wait');
    wait = parseInt(raw === null ? '0' : raw, 10);
    if (Number.isNaN(wait)) wait = 0;
  }

  function setDisabled(disabled) {
    if (!btnSend) return;
    if (disabled) {
      btnSend.disabled = true;
      btnSend.style.opacity = "0.6";
    } else {
      btnSend.disabled = false;
      btnSend.style.opacity = "1";
    }
  }

  function updateInfo(seconds) {
    if (!infoEl) return;
    if (seconds > 0) {
      infoEl.innerHTML = 'Envío disponible en <span>' + seconds + '</span>s';
    } else {
      infoEl.textContent = ''; // Limpiar mensaje si ya se puede enviar
    }
  }

  // iniciar comportamiento automático
  if (wait > 0) {
    setDisabled(true);
    updateInfo(wait);
    const interval = setInterval(()=>{
      wait -= 1;
      if (wait < 0) wait = 0;
      updateInfo(wait);
      if (wait <= 0) {
        clearInterval(interval);
        setDisabled(false);
      }
    }, 1000);
  } else {
    setDisabled(false);
    updateInfo(0);
  }

  // UX: evitar doble-submit
  if (btnSend) {
    btnSend.addEventListener('click', function(e){
      if (btnSend.disabled) { e.preventDefault(); return; }
      // feedback inmediato
      btnSend.textContent = 'Enviando…';
    });
  }
})();
</script>
{% endblock %}
