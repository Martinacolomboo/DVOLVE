{% extends "email_verification/base.html" %}
{% load static %}

{% block verify_content %}
<style>
/* estilos locales que fuerzan visibilidad */
.ev-card { max-width:560px; margin:6vh auto; padding:28px; background:#fffaf0; border-radius:12px; color:#5a4630; text-align:center; box-shadow:0 8px 20px rgba(0,0,0,0.06); }
.ev-code { padding:12px 14px; border-radius:10px; border:1px solid #d1c4b2; min-width:160px; font-size:16px; display:inline-block !important; visibility:visible !important; opacity:1 !important;box-sizing: border-box; }
.ev-submit { padding:10px 16px; border:none; border-radius:10px; background:linear-gradient(45deg,#c875ac,#7e2864); color:white; font-weight:700; cursor:pointer; }
.ev-msg { color:#b53f3f; margin-bottom:12px; }
.ev-resend {
  display:inline-block;
  margin-top:10px;
  background:transparent;
  border:2px solid #c875ac;
  color:#7e2864;
  font-weight:600;
  padding:8px 14px;
  border-radius:10px;
  text-decoration:none;
  transition:all .2s ease;
}
.ev-resend:hover {
  background:#c875ac;
  color:white;
  transform:translateY(-1px);
  box-shadow:0 3px 8px rgba(0,0,0,0.2);
}
#field-errors {
  /* altura fija aproximada: ajustá si tus mensajes son más grandes */
  min-height: 34px;
  line-height: 1.2;
}
.ev-volver{
  position:absolute;
  top:20px;
  left:20px;
  background:transparent;
  border:none;
  color:#7e2864;
  font-weight:600;
  cursor:pointer;
  text-decoration:underline;
}
@media (max-width:520px){ .ev-form { flex-direction:column } .ev-code{width:100%!important} .ev-submit{width:100%} }
</style>

<div class="ev-card">
  {% if messages %}
    <div class="ev-msg">{% for m in messages %}{{ m }}{% if not forloop.last %}<br>{% endif %}{% endfor %}</div>
  {% endif %}
  
  <h2 style="color:#7e2864">Ingresá el código</h2>
  <p style="color:#a88a66">Enviamos el código a <strong>{{ email }}</strong>. Revisá Spam si no lo ves.</p>

  <form method="post" class="ev-form" novalidate style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;align-items:center;">
    {% csrf_token %}
    <input type="hidden" name="email" value="{{ email }}">

    <div style="min-width:160px;">
      {% if form.code.errors %}
        <div class="ev-msg">{{ form.code.errors }}</div>
      {% endif %}

     {% if form.code %}
        {{ form.code }}
        <script>
          // si el widget tiene clase genérica, lo actualizamos a ev-code en runtime
          (function(){
            try{
              const el = document.querySelector('[name="code"]');
              if(el) el.classList.add('ev-code');
            }catch(e){}
          })();
        </script>
      {% else %}
        <input name="code" class="ev-code" placeholder="000000" inputmode="numeric" required
               value="{{ form.code.value|default:'' }}">
      {% endif %}
      <button type="submit" class="ev-submit">Verificar</button>
  
    </div>

  </form>
  <div style="display:flex;gap:10px;margin-top:16px;justify-content:center;align-items:center;">
    <form id="resend-form" method="post" action="{% url 'email_verification:request' %}" style="margin:0;">
      {% csrf_token %}
      <button id="btn-resend" type="submit" class="ev-resend">Cambiar email</button>
    </form>
    <form id="resend-form" method="post" action="{% url 'email_verification:resend' %}" style="margin:0;">
      {% csrf_token %}
      <button id="btn-resend" type="submit" class="ev-resend">Reenviar código</button>
    </form>
  </div>
    <div id="resend-info" data-wait="{{ resend_wait|default:0 }}" style="margin-top:10px;color:#7e2864;font-weight:600;">
    {% if resend_wait and resend_wait > 0 %}
      Reenviar disponible en <span id="resend-seconds">{{ resend_wait }}</span>s
    {% else %}
      Podés reenviar el código.
    {% endif %}
  </div>


</div>
<script>
(function(){
  // Elementos
  const infoEl = document.getElementById('resend-info');
  const secondsSpan = document.getElementById('resend-seconds');
  const btnResend = document.getElementById('btn-resend');
  const changeEmail = document.getElementById('change-email');

  // Lee el valor inicial desde data-wait (proporcionado por Django)
  let wait = 0;
  if (infoEl) {
    const raw = infoEl.getAttribute('data-wait');
    // parsear a entero de forma segura
    wait = parseInt(raw === null ? '0' : raw, 10);
    if (Number.isNaN(wait)) wait = 0;
  }

  // helpers para habilitar/deshabilitar botones
  function setDisabled(disabled){
    if (btnResend){
      btnResend.disabled = !!disabled;
      if(disabled) btnResend.classList.add('disabled'); else btnResend.classList.remove('disabled');
    }
    if (changeEmail){
      if(disabled) changeEmail.classList.add('disabled'); else changeEmail.classList.remove('disabled');
      if(disabled) changeEmail.setAttribute('aria-disabled','true'); else changeEmail.removeAttribute('aria-disabled');
    }
  }

  // Actualiza la UI del contador (segundos)
  function updateInfoText(secondsLeft){
    if (!infoEl) return;
    if (secondsLeft > 0){
      if (secondsSpan) secondsSpan.textContent = secondsLeft;
      else infoEl.innerHTML = 'Reenviar disponible en <span id="resend-seconds">'+secondsLeft+'</span>s';
    } else {
      infoEl.textContent = 'Ya podés reenviar el código.';
    }
  }

  // Iniciar contador si corresponde
  if (wait > 0){
    console.debug('Resend wait inicial:', wait);
    setDisabled(true);
    updateInfoText(wait);

    const interval = setInterval(()=>{
      wait -= 1;
      if (wait < 0) wait = 0;
      updateInfoText(wait);
      if (wait <= 0){
        clearInterval(interval);
        setDisabled(false);
      }
    }, 1000);
  } else {
    // sin espera
    setDisabled(false);
    updateInfoText(0);
  }

  // Prevención de doble envío / UX
  if (btnResend){
    btnResend.addEventListener('click', function(e){
      if (btnResend.disabled){
        e.preventDefault();
        return;
      }
      // mostrar feedback rápido (el POST llevará al servidor que reiniciará el cooldown)
      btnResend.textContent = 'Reenviando…';
      // dejar que el form se envíe normalmente
    });
  }

})();
</script>

{% endblock %}
